<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<script src="https://js.stripe.com/v3/"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<link th:href="@{/common.css}" rel="stylesheet"/>
<link th:href="@{/getItem.css}" rel="stylesheet"/>

<head>
    <meta charset="UTF-8">
    <title>Item Details</title>
</head>
<body>
<header>
    <div class="nav">
        <ul>
            <a href="/">Home</a>
            <a href="/auctions-page">Auctions</a>
            <a href="/register-page">Register</a>
            <a href="/login-page">Login</a>
            <a href="/addItem">Create</a>
            <a href="#contact">Contact</a>
        </ul>
    </div>
</header>
<section>
    <h1>Item Details</h1>
    <div id="item-details">
        <h3 th:text="'Name: ' + ${item.name}"></h3>
        <h3 th:text="'Description: ' + ${item.description}"></h3>
        <h3 th:text="'Current Bid: $' + ${item.currentBid}"></h3>
        <h3 th:unless="${item.auctionComplete}">Auction Status: Incomplete</h3>
        <h3>Auction Start Time: <span id="auctionStartTimeFormatted"></span></h3>
        <h3>Auction End Time: <span id="auctionEndTimeFormatted"></span></h3>
        <p id="demo"></p>
        <button id="bidButton">Place Bid</button>

        <div id="bidModal" class="modal">

            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Bid Form</h2>
                <form id="bidForm" th:action="@{'/updateBid/' + ${item.name} + '/' + ${userId} + '/' + ${item.currentBid}}" method="post">
                    <label for="newBidAmountInput">Enter Bid Amount:</label>
                    <input type="number" name="newBidAmount" id="newBidAmountInput" required />

                    <!-- Dropdown for payment methods -->
                    <label for="paymentMethod">Choose Payment Method:</label>
                    <select name="paymentMethod" id="paymentMethod">
                        <!-- Options will be dynamically populated using JavaScript -->
                    </select>

                    <label for="cvv">CVV:</label>
                    <input type="text" name="cvv" id="cvv" required />

                    <button type="submit">Place Bid</button>
                </form>
            </div>
        </div>


    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        var itemName = /*[[${item.name}]]*/ '';
        var auctionStartTimeString = /*[[${item.auctionStartTime}]]*/ '';
        var auctionEndTimeString = /*[[${item.auctionEndTime}]]*/ '';
       var auctionStartTimeFormatted = moment(auctionStartTimeString).format('YYYY-MM-DD');
    var auctionEndTimeFormatted = moment(auctionEndTimeString).format('YYYY-MM-DD');

        /*]]>*/
    </script>

    <script>
        $(document).ready(function() {
            // Display formatted auction start time and end time
            $('#auctionStartTimeFormatted').text(auctionStartTimeFormatted);
            $('#auctionEndTimeFormatted').text(auctionEndTimeFormatted);
        });
    </script>

    <script>

        $(document).ready(function() {
            $('#bidButton').click(function() {
                $('#bidModal').css("display", "block");
            });

            $('.close').click(function() {
                $('#bidModal').css("display", "none");
            });

            $(window).click(function(event) {
                if (event.target == $('#bidModal')[0]) {
                    $('#bidModal').css("display", "none");
                }
            });
        });
    </script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Assuming contentDiv is the parent element where you want to append the image
        const contentDiv = document.getElementById("item-details");

        // Assuming item is the object containing item details including the image
        var item = /*[[${item}]]*/; // Accessing item from Thymeleaf

        if (item.image !== null) {
            const imageData = atob(item.image);
            const imageDataUrl = `data:image/jpeg;base64,${imageData}`;

            const imageElement = document.createElement("img");
            imageElement.src = imageDataUrl;
            imageElement.alt = item.name; // Setting alt attribute

            // Set max-width and max-height for the image
            imageElement.style.maxWidth = "100%"; // Adjust this value as needed
            imageElement.style.maxHeight = "400px"; // Adjust this value as needed

            // Center the image
            imageElement.style.display = "block";
            imageElement.style.margin = "auto";

            // Prepend the image element to the contentDiv
            contentDiv.insertBefore(imageElement, contentDiv.firstChild);
        } else {
            const noImageElement = document.createElement("p");
            noImageElement.textContent = "No image available";
            contentDiv.appendChild(noImageElement);
        }
        /*]]>*/
    </script>

    <script>
        $(document).ready(function() {
       // Fetch user ID
       $.ajax({
           url: '/loggedUserID',
           type: 'GET',
           success: function(response) {
               console.log(response);
               if (response.userId !== '') {
                   const userId = response.userId;

                   // Populate payment methods dropdown
                   fetch('/retrieve-payment-methods?userId=' + userId)
                       .then(response => {
                           if (!response.ok) {
                               throw new Error('Failed to retrieve payment methods');
                           }
                           return response.json();
                       })
                       .then(data => {
                           const paymentMethodSelect = $('#paymentMethod');
                           data.forEach(paymentMethod => {
                               const option = $('<option></option>').text('Card ending with ' + paymentMethod.cardNumber.slice(-4));
                               paymentMethodSelect.append(option);
                           });
                       })
                       .catch(error => {
                           console.error('Error fetching payment methods:', error);
                       });

                   // Set user ID in the bid form
                   $('input[name="userId"]').val(userId);
                   console.log(userId);
               } else {
                   alert('You need to log in or register to place a bid.');
               }
           },
           error: function() {
               console.error('Error checking logged-in status.');
           }
       });

       // Handle bid form submission
       $('#bidForm').submit(function(e) {
           if ($('input[name="userId"]').val() === '') {
               e.preventDefault(); // Prevent form submission
               alert('You need to log in or register to place a bid.');
           } else {
               var userId = $('input[name="userId"]').val();
               var actionUrl = '/updateBid/' + itemName + '/' + userId + '/' + $('input[name="newBidAmount"]').val(); // Use newBidAmount input field
               $('#bidForm').attr('action', actionUrl);
           }
       });
   });

    </script>

    <script>
        $(document).ready(function() {
          var auctionEndTime = new Date(auctionEndTimeString).getTime();

          var x = setInterval(function() {
              var now = new Date().getTime();
              var distance = auctionEndTime - now;
              var days = Math.floor(distance / (1000 * 60 * 60 * 24));
              var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
              var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
              var seconds = Math.floor((distance % (1000 * 60)) / 1000);

              document.getElementById("demo").innerHTML = "Time Remaining to make a bid: " + days + "d " + hours + "h " + minutes + "m " + seconds + "s";

              if (distance < 0) {
                  clearInterval(x);
                  document.getElementById("demo").innerHTML = "Auction Ended";
              }
          }, 1000);
      });
    </script>

</section>
</body>
</html>